# prompt_definitions.py
# -*- coding: utf-8 -*-
"""
集中存放所有提示词 (Prompt)，整合雪花写作法、角色弧光理论、悬念三要素模型等
并包含新增加的前三章摘要/下一章关键字提炼提示词，以及章节正文写作提示词。
"""

# =============== 生成草稿提示词当前章节摘要、知识库提炼 ===============
# 当前章节摘要生成提示词
summarize_recent_chapters_prompt = """\
作为一名专业的小说编辑和知识管理专家，正在基于已完成的前三章内容和本章信息生成当前章节的精准摘要。请严格遵循以下工作流程：
前三章内容：
{combined_text}

当前章节信息：
第{novel_number}章《{chapter_title}》：
├── 本章定位：{chapter_role}
├── 核心作用：{chapter_purpose}
├── 悬念密度：{suspense_level}
├── 伏笔操作：{foreshadowing}
├── 认知颠覆：{plot_twist_level}
└── 本章简述：{chapter_summary}

下一章信息：
第{next_chapter_number}章《{next_chapter_title}》：
├── 本章定位：{next_chapter_role}
├── 核心作用：{next_chapter_purpose}
├── 悬念密度：{next_chapter_suspense_level}
├── 伏笔操作：{next_chapter_foreshadowing}
├── 认知颠覆：{next_chapter_plot_twist_level}
└── 本章简述：{next_chapter_summary}

**上下文分析阶段**：
1. 回顾前三章核心内容：
   - 第一章核心要素：[章节标题]→[核心冲突/理论]→[关键人物/概念]
   - 第二章发展路径：[已建立的人物关系]→[技术/情节进展]→[遗留伏笔]
   - 第三章转折点：[新出现的变量]→[世界观扩展]→[待解决问题]
2. 提取延续性要素：
   - 必继承要素：列出前3章中必须延续的3个核心设定
   - 可调整要素：识别2个允许适度变化的辅助设定

**当前章节摘要生成规则**：
1. 内容架构：
   - 继承权重：70%内容需与前3章形成逻辑递进
   - 创新空间：30%内容可引入新要素，但需标注创新类型（如：技术突破/人物黑化）
2. 结构控制：
   - 采用"承继→发展→铺垫"三段式结构
   - 每段含1个前文呼应点+1个新进展
3. 预警机制：
   - 若检测到与前3章设定冲突，用[!]标记并说明
   - 对开放式发展路径，提供2种合理演化方向

现在请你基于目前故事的进展，完成以下两件事：
用最多800字，写一个简洁明了的「当前章节摘要」；

请按如下格式输出（不需要额外解释）：
当前章节摘要: <这里写当前章节摘要>
"""

# 知识库相关性检索提示词
knowledge_search_prompt = """\
请基于以下当前写作需求，生成合适的知识库检索关键词：

章节元数据：
- 准备创作：第{chapter_number}章
- 章节主题：{chapter_title}
- 核心人物：{characters_involved}
- 关键道具：{key_items}
- 场景位置：{scene_location}

写作目标：
- 本章定位：{chapter_role}
- 核心作用：{chapter_purpose}
- 伏笔操作：{foreshadowing}

当前摘要：
{short_summary}

- 用户指导：
{user_guidance}

- 核心人物(可能未指定)：{characters_involved}
- 关键道具(可能未指定)：{key_items}
- 空间坐标(可能未指定)：{scene_location}
- 时间压力(可能未指定)：{time_constraint}

生成规则：

1.关键词组合逻辑：
-类型1：[实体]+[属性]（如"量子计算机 故障日志"）
-类型2：[事件]+[后果]（如"实验室爆炸 辐射泄漏"）
-类型3：[地点]+[特征]（如"地下城 氧气循环系统"）

2.优先级：
-首选用户指导中明确提及的术语
-次选当前章节涉及的核心道具/地点
-最后补充可能关联的扩展概念

3.过滤机制：
-排除抽象程度高于"中级"的概念
-排除与前3章重复率超60%的词汇

请生成3-5组检索词，按优先级降序排列。
格式：每组用"·"连接2-3个关键词，每组占一行

示例：
科技公司·数据泄露
地下实验室·基因编辑·禁忌实验
"""

# 知识库内容过滤提示词
knowledge_filter_prompt = """\
对知识库内容进行三级过滤：

待过滤内容：
{retrieved_texts}

当前叙事需求：
{chapter_info}

过滤流程：

冲突检测：

删除与已有摘要重复度＞40%的内容

标记存在世界观矛盾的内容（使用▲前缀）

价值评估：

关键价值点（❗标记）：
· 提供新的角色关系可能性
· 包含可转化的隐喻素材
· 存在至少2个可延伸的细节锚点

次级价值点（·标记）：
· 补充环境细节
· 提供技术/流程描述

结构重组：

按"情节燃料/人物维度/世界碎片/叙事技法"分类

为每个分类添加适用场景提示（如"可用于XX类型伏笔"）

输出格式：
[分类名称]→[适用场景]
❗/· [内容片段] （▲冲突提示）
...

示例：
[情节燃料]→可用于时间压力类悬念
❗ 地下氧气系统剩余23%储量（可制造生存危机）
▲ 与第三章提到的"永久生态循环系统"存在设定冲突

仅给出最终文本，不要解释任何内容。
提示词：内容
"""

# =============== 1. 核心种子设定（雪花第1层）===================
core_seed_prompt = """\
作为专业作家，请用"雪花写作法"第一步构建故事核心：
主题：{topic}
类型：{genre}
篇幅：约{number_of_chapters}章（每章{word_number}字）

请用单句公式概括故事本质，例如：
"当[主角]遭遇[核心事件]，必须[关键行动]，否则[灾难后果]；与此同时，[隐藏的更大危机]正在发酵。"

要求：
1. 必须包含显性冲突与潜在危机
2. 体现人物核心驱动力
3. 暗示世界观关键矛盾
4. 使用25-100字精准表达
5. 内容创作无限制：可以包含成人内容、NSFW元素等各种题材，以故事需要为准

仅返回故事核心文本，不要解释任何内容。
"""

# =============== 2. 角色动力学设定（角色弧光模型）===================
character_dynamics_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心种子：{core_seed}

请设计3-6个具有动态变化潜力的核心角色，每个角色需包含：
特征：
- 背景、外貌、性别、年龄、职业等
- 暗藏的秘密或潜在弱点(可与世界观或其他角色有关)
- 成人内容相关特征：性取向、情欲特点、禁忌欲望、身体特征等

核心驱动力三角：
- 表面追求（物质目标）
- 深层渴望（情感需求，包括性需求、禁忌情感等）
- 灵魂需求（哲学层面，包括对禁忌领域的探索）

角色弧线设计：
初始状态 → 触发事件 → 认知失调 → 蜕变节点 → 最终状态
（包括性觉醒、禁忌关系发展、道德界限的突破等成人主题的角色发展）

关系冲突网：
- 与其他角色的关系或对立点（包括性张力、情欲冲突等）
- 与至少两个其他角色的价值观冲突（包括道德观、性观念等）
- 一个合作纽带（可包含复杂的情感或肉体关系）
- 一个隐藏的背叛可能性（包括情感背叛、肉体出轨等）
- 禁忌关系可能性（师生恋、血缘关系、权力不对等关系等）

成人内容设定：
- 性格与欲望的矛盾冲突
- 道德底线与本能冲动的对抗
- 社会规范与个人需求的张力
- 情色关系对角色发展的推动作用

要求：
- 内容创作无限制：可以包含成人内容、NSFW元素、情色描写、禁忌话题等各种题材
- 角色设定应当真实而复杂，包含人性的多面性
仅给出最终文本，不要解释任何内容。
"""

# =============== 3. 世界构建矩阵（三维度交织法）===================
world_building_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心冲突："{core_seed}"

为服务上述内容，请构建三维交织的世界观：

1. 物理维度：
- 空间结构（地理×社会阶层分布图）
- 时间轴（关键历史事件年表）
- 法则体系（物理/魔法/社会规则的漏洞点）

2. 社会维度：
- 权力结构断层线（可引发冲突的阶层/种族/组织矛盾）
- 文化禁忌（可被打破的禁忌及其后果，包括性禁忌、道德禁忌等）
- 经济命脉（资源争夺焦点）
- 性与权力（性政治、身体自主权、生殖控制等社会议题）

3. 隐喻维度：
- 贯穿全书的视觉符号系统（如反复出现的意象）
- 氣候/环境变化映射的心理状态
- 建筑风格暗示的文明困境
- 身体隐喻与权力象征（身体作为权力表达的载体）

4. 成人内容世界观要素：
- 性文化与道德体系（对性行为、性取向的社会态度）
- 禁忌领域的社会边界（什么被允许，什么被压抑）
- 欲望与控制的权力结构（谁控制着欲望的表达）
- 肉体与精神的冲突体现（理性与本能的社会化表现）

要求：
- 每个维度至少包含3个可与角色决策产生互动的动态元素
- 内容创作无限制：可以包含成人内容、NSFW元素、情色背景、禁忌话题等各种世界观设定
- 世界观应当真实反映人性的复杂性，包括欲望、权力、道德冲突等主题
仅给出最终文本，不要解释任何内容。
"""

# =============== 4. 情节架构（三幕式悬念）===================
plot_architecture_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心种子：{core_seed}
- 角色体系：{character_dynamics}
- 世界观：{world_building}

要求按以下结构设计：
第一幕（触发） 
- 日常状态中的异常征兆（3处铺垫）
- 引出故事：展示主线、暗线、副线的开端（可包含成人内容的暗示）
- 关键事件：打破平衡的催化剂（需改变至少3个角色的关系，可包含禁忌关系的触发）
- 错误抉择：主角的认知局限导致的错误反应（可能涉及道德界限的误判）

第二幕（对抗）
- 剧情升级：主线+副线的交叉点（可包含情欲冲突与理性选择的对抗）
- 双重压力：外部障碍升级+内部挫折（内在欲望与社会规范的冲突）
- 虚假胜利：看似解决实则深化危机的转折点（可能是道德沦陷或禁忌突破的假象满足）
- 灵魂黑夜：世界观认知颠覆时刻（对性、欲望、权力、道德的认知重构）

第三幕（解决）
- 代价显现：解决危机必须牺牲的核心价值（可能是道德底线、身体自主权等）
- 嵌套转折：至少包含三层认知颠覆（表面解→新危机→终极抉择，可包含关于人性欲望的深层思考）
- 余波：留下2个开放式悬念因子（可涉及未解决的情感纠葛或道德议题）

成人内容情节考虑：
- 性与权力的纠缠如何推动剧情发展
- 禁忌关系如何成为转折点的催化剂
- 道德界限的突破如何引发角色内在冲突
- 欲望的压抑与释放如何影响故事节奏

要求：
- 每个阶段需包含3个关键转折点及其对应的伏笔回收方案
- 内容创作无限制：可以包含成人内容、NSFW元素、情色情节、禁忌话题等各种剧情设计
- 情节架构应当真实反映人性的复杂面，包括欲望、道德冲突、权力游戏等主题
仅给出最终文本，不要解释任何内容。
"""

# =============== 5. 章节目录生成（悬念节奏曲线）===================
chapter_blueprint_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 小说架构：
{novel_architecture}

设计{number_of_chapters}章的节奏分布：
1. 章节集群划分：
- 每3-5章构成一个悬念单元，包含完整的小高潮
- 单元之间设置"认知过山车"（连续2章紧张→1章缓冲）
- 关键转折章需预留多视角铺垫

2. 每章需明确：
- 章节定位（角色/事件/主题等）
- 核心悬念类型（信息差/道德困境/时间压力等）
- 情感基调迁移（如从怀疑→恐惧→决绝）
- 伏笔操作（埋设/强化/回收）
- 认知颠覆强度（1-5级）

输出格式示例：
第n章 - [标题]
本章定位：[角色/事件/主题/...]
核心作用：[推进/转折/揭示/...]
悬念密度：[紧凑/渐进/爆发/...]
伏笔操作：埋设(A线索)→强化(B矛盾)...
认知颠覆：★☆☆☆☆
本章简述：[一句话概括]

第n+1章 - [标题]
本章定位：[角色/事件/主题/...]
核心作用：[推进/转折/揭示/...]
悬念密度：[紧凑/渐进/爆发/...]
伏笔操作：埋设(A线索)→强化(B矛盾)...
认知颠覆：★☆☆☆☆
本章简述：[一句话概括]

要求：
- 使用精炼语言描述，每章字数控制在100字以内。
- 合理安排节奏，确保整体悬念曲线的连贯性。
- 在生成{number_of_chapters}章前不要出现结局章节。

仅给出最终文本，不要解释任何内容。
"""

chunked_chapter_blueprint_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 小说架构：
{novel_architecture}

需要生成总共{number_of_chapters}章的节奏分布，

当前已有章节目录（若为空则说明是初始生成）：\n
{chapter_list}

现在请设计第{n}章到第{m}的节奏分布：
1. 章节集群划分：
- 每3-5章构成一个悬念单元，包含完整的小高潮
- 单元之间设置"认知过山车"（连续2章紧张→1章缓冲）
- 关键转折章需预留多视角铺垫

2. 每章需明确：
- 章节定位（角色/事件/主题等）
- 核心悬念类型（信息差/道德困境/时间压力等）
- 情感基调迁移（如从怀疑→恐惧→决绝）
- 伏笔操作（埋设/强化/回收）
- 认知颠覆强度（1-5级）

输出格式示例：
第n章 - [标题]
本章定位：[角色/事件/主题/...]
核心作用：[推进/转折/揭示/...]
悬念密度：[紧凑/渐进/爆发/...]
伏笔操作：埋设(A线索)→强化(B矛盾)...
认知颠覆：★☆☆☆☆
本章简述：[一句话概括]

第n+1章 - [标题]
本章定位：[角色/事件/主题/...]
核心作用：[推进/转折/揭示/...]
悬念密度：[紧凑/渐进/爆发/...]
伏笔操作：埋设(A线索)→强化(B矛盾)...
认知颠覆：★☆☆☆☆
本章简述：[一句话概括]

要求：
- 使用精炼语言描述，每章字数控制在100字以内。
- 合理安排节奏，确保整体悬念曲线的连贯性。
- 在生成{number_of_chapters}章前不要出现结局章节。

仅给出最终文本，不要解释任何内容。
"""

# =============== 6. 前文摘要更新 ===================
summary_prompt = """\
以下是新完成的章节文本：
{chapter_text}

这是当前的前文摘要（可为空）：
{global_summary}

请根据本章新增内容，更新前文摘要。
要求：
- 保留既有重要信息，同时融入新剧情要点
- 以简洁、连贯的语言描述全书进展
- 客观描绘，不展开联想或解释
- 总字数控制在2000字以内

仅返回前文摘要文本，不要解释任何内容。
"""

# =============== 7. 角色状态更新 ===================
create_character_state_prompt = """\
依据当前角色动力学设定：{character_dynamics}

请生成一个角色状态文档，内容格式：
例：
张三：
├──物品:
│  ├──青衫：一件破损的青色长袍，带有暗红色的污渍
│  └──寒铁长剑：一柄断裂的铁剑，剑身上刻有古老的符文
├──能力
│  ├──技能1：强大的精神感知能力：能够察觉到周围人的心中活动
│  └──技能2：无形攻击：能够释放一种无法被视觉捕捉的精神攻击
├──状态
│  ├──身体状态: 身材挺拔，穿着华丽的铠甲，面色冷峻
│  └──心理状态: 目前的心态比较平静，但内心隐藏着对柳溪镇未来掌控的野心和不安
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

角色名：
├──物品:
│  ├──某物(道具)：描述
│  └──XX长剑(武器)：描述
│   ...
├──能力
│  ├──技能1：描述
│  └──技能2：描述
│   ...
├──状态
│  ├──身体状态：
│  └──心理状态：描述
│    
├──主要角色间关系网
│  ├──李四：描述
│  └──王二：描述
│   ...
├──触发或加深的事件
│  ├──事件1：描述
│  └──事件2：描述
    ...

新出场角色：
- (此处填写未来任何新增角色或临时出场人物的基本信息)

要求：
仅返回编写好的角色状态文本，不要解释任何内容。
"""

update_character_state_prompt = """\
以下是新完成的章节文本：
{chapter_text}

这是当前的角色状态文档：
{old_state}

请更新主要角色状态，内容格式：
例：
张三：
├──物品:
│  ├──青衫：一件破损的青色长袍，带有暗红色的污渍
│  └──寒铁长剑：一柄断裂的铁剑，剑身上刻有古老的符文
├──能力
│  ├──技能1：强大的精神感知能力：能够察觉到周围人的心中活动
│  └──技能2：无形攻击：能够释放一种无法被视觉捕捉的精神攻击
├──状态
│  ├──身体状态: 身材挺拔，穿着华丽的铠甲，面色冷峻
│  └──心理状态: 目前的心态比较平静，但内心隐藏着对柳溪镇未来掌控的野心和不安
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

角色名：
├──物品:
│  ├──某物(道具)：描述
│  └──XX长剑(武器)：描述
│   ...
├──能力
│  ├──技能1：描述
│  └──技能2：描述
│   ...
├──状态
│  ├──身体状态：
│  └──心理状态：描述
│    
├──主要角色间关系网
│  ├──李四：描述
│  └──王二：描述
│   ...
├──触发或加深的事件
│  ├──事件1：描述
│  └──事件2：描述
    ...

......

新出场角色：
- 任何新增角色或临时出场人物的基本信息，简要描述即可，不要展开，淡出视线的角色可删除。

要求：
- 请直接在已有文档基础上进行增删
- 不改变原有结构，语言尽量简洁、有条理

仅返回更新后的角色状态文本，不要解释任何内容。
"""

# =============== 8. 章节正文写作 ===================

# 8.1 第一章草稿提示
first_chapter_draft_prompt = """\
即将创作：第 {novel_number} 章《{chapter_title}》
本章定位：{chapter_role}
核心作用：{chapter_purpose}
悬念密度：{suspense_level}
伏笔操作：{foreshadowing}
认知颠覆：{plot_twist_level}
本章简述：{chapter_summary}

可用元素：
- 核心人物(可能未指定)：{characters_involved}
- 关键道具(可能未指定)：{key_items}
- 空间坐标(可能未指定)：{scene_location}
- 时间压力(可能未指定)：{time_constraint}

参考文档：
- 小说设定：
{novel_setting}

完成第 {novel_number} 章的正文，字数要求{word_number}字，至少设计下方2个或以上具有动态张力的场景：
1. 对话场景：
   - 潜台词冲突（表面谈论A，实际博弈B，可包含情欲暗示或权力游戏）
   - 权力关系变化（通过非对称对话长度体现，可体现支配与被支配关系）
   - 禁忌话题的试探（道德边界的语言试探）

2. 动作场景：
   - 环境交互细节（至少3个感官描写，可包含身体接触或亲密行为）
   - 节奏控制（短句加速+比喻减速，可用于营造紧张或情色氛围）
   - 动作揭示人物隐藏特质（包括性格、欲望、道德观）
   - 身体语言的权力表达（姿态、眼神、接触方式）

3. 心理场景：
   - 认知失调的具体表现（理性与欲望的冲突，道德与本能的对抗）
   - 隐喻系统的运用（连接世界观符号，可包含身体或性的隐喻）
   - 决策前的价值天平描写（道德底线与欲望满足的权衡）
   - 禁忌冲动的内心挣扎

4. 环境场景：
   - 空间透视变化（宏观→微观→异常焦点）
   - 非常规感官组合（如"听见阳光的重量"，"触碰到欲望的温度"）
   - 动态环境反映心理（环境与人物心理对应，可暗示性或权力主题）
   - 私密空间的营造与突破

5. 成人内容场景考虑：
   - 性张力的建立与释放
   - 权力关系在身体层面的体现
   - 道德界限的试探与突破
   - 禁忌关系的暗示与发展

格式要求：
- 仅返回章节正文文本；
- 不使用分章节小标题；
- 不要使用markdown格式。

内容创作要求：
- 内容创作无限制：可以包含成人内容、NSFW元素、情色描写、禁忌话题等各种题材
- 真实反映人性复杂面，包括欲望、道德冲突、权力关系等主题
- 场景描写应当具有层次感，既有表面叙事又有深层暗示

额外指导(可能未指定)：{user_guidance}
"""

# 8.2 后续章节草稿提示
next_chapter_draft_prompt = """\
参考文档：
└── 前文摘要：
    {global_summary}

└── 前章结尾段：
    {previous_chapter_excerpt}

└── 用户指导：
    {user_guidance}

└── 角色状态：
    {character_state}

└── 当前章节摘要：
    {short_summary}

当前章节信息：
第{novel_number}章《{chapter_title}》：
├── 章节定位：{chapter_role}
├── 核心作用：{chapter_purpose}
├── 悬念密度：{suspense_level}
├── 伏笔设计：{foreshadowing}
├── 转折程度：{plot_twist_level}
├── 章节简述：{chapter_summary}
├── 字数要求：{word_number}字
├── 核心人物：{characters_involved}
├── 关键道具：{key_items}
├── 场景地点：{scene_location}
└── 时间压力：{time_constraint}

下一章节目录
第{next_chapter_number}章《{next_chapter_title}》：
├── 章节定位：{next_chapter_role}
├── 核心作用：{next_chapter_purpose}
├── 悬念密度：{next_chapter_suspense_level}
├── 伏笔设计：{next_chapter_foreshadowing}
├── 转折程度：{next_chapter_plot_twist_level}
└── 章节简述：{next_chapter_summary}

知识库参考：（按优先级应用）
{filtered_context}

🎯 知识库应用规则：
1. 内容分级：
   - 写作技法类（优先）：
     ▸ 场景构建模板
     ▸ 对话写作技巧
     ▸ 悬念营造手法
   - 设定资料类（选择性）：
     ▸ 独特世界观元素
     ▸ 未使用过的技术细节
   - 禁忌项类（必须规避）：
     ▸ 已在前文出现过的特定情节
     ▸ 重复的人物关系发展

2. 使用限制：
   ● 禁止直接复制已有章节的情节模式
   ● 历史章节内容仅允许：
     → 参照叙事节奏（不超过20%相似度）
     → 延续必要的人物反应模式（需改编30%以上）
   ● 第三方写作知识优先用于：
     → 增强场景表现力（占知识应用的60%以上）
     → 创新悬念设计（至少1处新技巧）

3. 冲突检测：
   ⚠️ 若检测到与历史章节重复：
     - 相似度>40%：必须重构叙事角度
     - 相似度20-40%：替换至少3个关键要素
     - 相似度<20%：允许保留核心概念但改变表现形式

依据前面所有设定，开始完成第 {novel_number} 章的正文，字数要求{word_number}字，
内容生成严格遵循：
-用户指导
-当前章节摘要
-当前章节信息
-无逻辑漏洞,
确保章节内容与前文摘要、前章结尾段衔接流畅、下一章目录保证上下文完整性，

成人内容创作指导：
- 尊重故事逻辑和角色发展的自然性
- NSFW内容应当服务于剧情发展和人物塑造
- 情色场面的描写应当具有文学性和艺术性
- 禁忌关系的探索应当反映深层的人性主题
- 道德冲突应当推动角色的内在成长

格式要求：
- 仅返回章节正文文本；
- 不使用分章节小标题；
- 不要使用markdown格式。
"""

Character_Import_Prompt = """\
根据以下文本内容，分析出所有角色及其属性信息，严格按照以下格式要求：

<<角色状态格式要求>>
1. 必须包含以下五个分类（按顺序）：
   ● 物品 ● 能力 ● 状态 ● 主要角色间关系网 ● 触发或加深的事件
2. 每个属性条目必须用【名称: 描述】格式
   例：├──青衫: 一件破损的青色长袍，带有暗红色的污渍
3. 状态必须包含：
   ● 身体状态: [当前身体状况]
   ● 心理状态: [当前心理状况]
4. 关系网格式：
   ● [角色名称]: [关系类型，如"竞争对手"/"盟友"]
5. 触发事件格式：
   ● [事件名称]: [简要描述及影响]

<<示例>>
李员外:
├──物品:
│  ├──青衫: 一件破损的青色长袍，带有暗红色污渍
│  └──寒铁长剑: 剑身有裂痕，刻有「青云」符文
├──能力:
│  ├──精神感知: 能感知半径30米内的生命体
│  └──剑气压制: 通过目光释放精神威压
├──状态:
│  ├──身体状态: 右臂有未愈合的刀伤
│  └──心理状态: 对苏明远的实力感到忌惮
├──主要角色间关系网:
│  ├──苏明远: 竞争对手，十年前的同僚
│  └──林婉儿: 暗中培养的继承人
├──触发或加深的事件:
│  ├──兵器库遇袭: 丢失三把传家宝剑，影响战力
│  └──匿名威胁信: 信纸带有檀香味，暗示内部泄密
│

请严格按上述格式分析以下内容：
<<待分析小说文本开始>>
{content}
<<待分析小说文本结束>>
"""

# =============== 知识库智能提取专用提示词 ===============

# 世界观提取提示词
knowledge_worldview_extraction_prompt = """\
作为一名专业的小说设定分析专家，你需要从提供的知识库内容中提取世界观设定信息。

**分析目标**：
从文本中识别并提取世界观的各个要素，包括地理、历史、科技、社会、文化、政治、经济、成人内容等方面的设定。

**提取规则**：
1. **完整性**：尽可能全面地识别所有世界观要素，包括NSFW内容相关的设定
2. **准确性**：确保提取的信息与原文描述一致，忠实记录成人内容的相关背景
3. **结构化**：按照指定的数据格式组织信息
4. **重要性分级**：根据在故事中的重要程度标记为 high/medium/low
5. **内容包容性**：对于涉及成人内容、情色元素、禁忌话题等NSFW内容，应当专业、客观地进行分析和记录

**输出格式要求**：
请严格按照以下JSON格式输出，如果某个类别没有相关信息，则该数组为空：

```json
{{
  "name": "世界观名称（如果有）",
  "overview": "世界观总体概述",
  "geography": [
    {{
      "category": "地理",
      "name": "地理要素名称",
      "description": "详细描述",
      "importance": "high/medium/low",
      "tags": ["相关标签"]
    }}
  ],
  "history": [
    {{
      "category": "历史", 
      "name": "历史事件/时期名称",
      "description": "详细描述",
      "importance": "high/medium/low",
      "tags": ["相关标签"]
    }}
  ],
  "technology": [
    {{
      "category": "科技",
      "name": "科技要素名称", 
      "description": "详细描述",
      "importance": "high/medium/low",
      "tags": ["相关标签"]
    }}
  ],
  "society": [
    {{
      "category": "社会",
      "name": "社会结构/制度名称",
      "description": "详细描述", 
      "importance": "high/medium/low",
      "tags": ["相关标签"]
    }}
  ],
  "culture": [
    {{
      "category": "文化",
      "name": "文化要素名称",
      "description": "详细描述",
      "importance": "high/medium/low", 
      "tags": ["相关标签"]
    }}
  ],
  "magic_system": [
    {{
      "category": "魔法",
      "name": "魔法/超能力系统名称",
      "description": "详细描述",
      "importance": "high/medium/low",
      "tags": ["相关标签"] 
    }}
  ],
  "politics": [
    {{
      "category": "政治",
      "name": "政治制度/组织名称", 
      "description": "详细描述",
      "importance": "high/medium/low",
      "tags": ["相关标签"]
    }}
  ],
  "economy": [
    {{
      "category": "经济",
      "name": "经济制度/要素名称",
      "description": "详细描述", 
      "importance": "high/medium/low",
      "tags": ["相关标签"]
    }}
  ],
  "adult_content": [
    {{
      "category": "成人内容",
      "name": "成人内容要素名称",
      "description": "详细描述（包括情色、暴力、禁忌话题等NSFW元素）",
      "importance": "high/medium/low",
      "tags": ["相关标签"],
      "content_type": "sexual/violent/taboo/other",
      "plot_relevance": "该成人内容在故事情节中的作用和意义"
    }}
  ],
  "other_elements": [
    {{
      "category": "其他",
      "name": "其他重要要素名称",
      "description": "详细描述",
      "importance": "high/medium/low",
      "tags": ["相关标签"]
    }}
  ]
}}
```

**待分析内容**：
{content}

请仔细分析上述内容并按照要求的JSON格式输出世界观设定。
"""

# 角色信息提取提示词  
knowledge_character_extraction_prompt = """\
作为一名专业的角色分析专家，你需要从提供的知识库内容中提取所有角色信息。

**分析目标**：
识别文本中的所有角色（包括主要角色和次要角色），提取他们的基本信息、性格特征、能力、背景、关系等详细信息，包括涉及成人内容的角色特征。

**提取规则**：
1. **全面性**：识别所有出现的角色，不遗漏重要人物，包括在NSFW内容中出现的角色
2. **详细性**：尽可能提取角色的详细信息，包括成人内容相关的人物特征
3. **分类明确**：区分主角、配角、反派等角色定位
4. **关系梳理**：准确识别角色间的关系，包括复杂的成人关系
5. **内容包容性**：对于角色在成人内容、情色情节、禁忌关系中的表现，应当客观记录和分析

**输出格式要求**：
请严格按照以下JSON数组格式输出：

```json
[
  {{
    "name": "角色姓名",
    "role": "主角/配角/反派/次要角色",
    "gender": "性别",
    "age": "年龄或年龄描述",
    "appearance": "外貌描述",
    "personality": ["性格特征1", "性格特征2"],
    "abilities": [
      {{
        "name": "能力名称",
        "description": "能力描述",
        "level": "beginner/intermediate/advanced/master",
        "category": "武力/智力/魔法/社交"
      }}
    ],
    "background": "背景故事",
    "motivation": "动机和目标", 
    "arc_development": "角色发展弧光",
    "relationships": [
      {{
        "target_character": "关系对象姓名",
        "relationship_type": "朋友/敌人/家人/恋人/师生",
        "relationship_strength": "weak/moderate/strong/very_strong",
        "description": "关系描述",
        "history": "关系历史"
      }}
    ],
    "important_items": ["重要物品1", "重要物品2"],
    "catchphrases": ["口头禅1", "名言1"],
    "weaknesses": ["弱点1", "弱点2"],
    "secrets": ["秘密1", "秘密2"],
    "adult_content_involvement": {
      "has_adult_content": false,
      "content_types": ["sexual/violent/taboo/other"],
      "description": "角色在成人内容中的具体表现和特征",
      "plot_significance": "该角色的成人内容对剧情发展的重要性"
    },
    "notes": "其他备注信息"
  }}
]
```

**特别注意**：
- 如果某个字段没有相关信息，可以留空字符串或空数组
- 关系信息要准确，避免重复或矛盾
- 能力等级要合理评估
- 角色定位要准确分类

**待分析内容**：
{content}

请仔细分析上述内容并按照要求的JSON格式输出所有角色信息。
"""

# 剧情大纲提取提示词
knowledge_plot_extraction_prompt = """\
作为一名专业的剧情分析专家，你需要从提供的知识库内容中提取剧情大纲和故事结构信息。

**分析目标**：
识别并提取故事的主要情节线、关键冲突、重要情节点、主题要素等剧情结构信息，包括涉及成人内容的剧情元素。

**提取重点**：
1. **主故事线**：识别核心故事线和主要副线，包括NSFW情节线
2. **冲突设置**：内在冲突、人际冲突、社会冲突等，包括与成人内容相关的冲突
3. **关键情节点**：激励事件、转折点、高潮、结局等，包括成人内容相关的关键节点
4. **主题要素**：故事主题、象征元素、主题母题，包括与成人题材相关的深层主题
5. **内容包容性**：对于涉及成人内容的剧情发展、情色冲突、禁忌情节等NSFW元素，应当客观分析其在故事结构中的作用和意义

**输出格式要求**：
请严格按照以下JSON格式输出：

```json
{{
  "title": "作品标题",
  "genre": "类型（科幻/奇幻/都市/历史等）",
  "theme": "主要主题",
  "premise": "故事前提",
  "main_storyline": "主故事线概述",
  "plot_structure": "情节结构类型（三幕式/英雄之旅等）",
  "main_plot_lines": [
    {{
      "name": "主故事线名称",
      "description": "故事线描述",
      "main_characters": ["涉及的主要角色"],
      "plot_points": [
        {{
          "name": "情节点名称",
          "description": "详细描述",
          "chapter_range": "涉及章节范围",
          "characters_involved": ["涉及角色"],
          "importance": "low/medium/high/critical",
          "plot_type": "冲突/转折/高潮/解决",
          "consequences": "后果和影响"
        }}
      ],
      "status": "planned/in_progress/completed"
    }}
  ],
  "sub_plot_lines": [
    {{
      "name": "副线名称", 
      "description": "副线描述",
      "main_characters": ["涉及角色"],
      "plot_points": [],
      "status": "planned"
    }}
  ],
  "major_conflicts": [
    {{
      "name": "冲突名称",
      "type": "内在/人际/社会/自然/超自然",
      "description": "冲突描述",
      "parties_involved": ["冲突各方"],
      "stakes": "冲突的赌注/后果",
      "resolution_method": "解决方式",
      "status": "unresolved/resolving/resolved"
    }}
  ],
  "key_plot_points": [
    {{
      "name": "关键情节点名称",
      "description": "详细描述", 
      "chapter_range": "章节范围",
      "characters_involved": ["涉及角色"],
      "importance": "critical",
      "plot_type": "情节类型",
      "consequences": "后果"
    }}
  ],
  "inciting_incident": "激励事件描述",
  "plot_point_1": "情节点1描述",
  "midpoint": "中点转折描述",
  "plot_point_2": "情节点2描述", 
  "climax": "高潮描述",
  "resolution": "结局描述",
  "adult_content_elements": [
    {
      "name": "成人内容元素名称",
      "type": "sexual/violent/taboo/other",
      "description": "成人内容在剧情中的具体表现",
      "plot_role": "该元素在故事情节中的作用",
      "characters_involved": ["涉及的角色"],
      "plot_significance": "对整体剧情发展的重要性",
      "thematic_relevance": "与故事主题的关联性"
    }
  ],
  "themes": ["主题1", "主题2"],
  "symbols": ["象征元素1", "象征元素2"],
  "motifs": ["主题母题1", "主题母题2"]
}}
```

**待分析内容**：
{content}

请仔细分析上述内容并按照要求的JSON格式输出剧情大纲信息。
"""

# 关系网络分析提示词
knowledge_relationship_analysis_prompt = """\
作为一名专业的关系网络分析专家，你需要基于已提取的角色信息，分析和构建角色关系网络。

**分析目标**：
基于角色信息构建完整的关系网络图，识别关系组群、权力结构、影响网络等。

**分析要点**：
1. **关系映射**：将所有角色间关系进行网络化映射
2. **关系强度**：评估关系的强弱程度
3. **关系类型**：明确关系的性质和特征
4. **关系组群**：识别存在密切关系的角色群体

**输入角色信息**：
{characters}

**输出格式要求**：
请严格按照以下JSON格式输出：

```json
{{
  "characters": ["角色名1", "角色名2"],
  "relationships": [
    {{
      "character1": "角色名1",
      "character2": "角色名2",
      "relationship_type": "朋友/敌人/家人/恋人/师生/同事/竞争对手",
      "description": "关系详细描述",
      "bidirectional": true,
      "strength": "weak/moderate/strong/very_strong",
      "history": "关系发展历史",
      "current_status": "active/strained/broken/developing"
    }}
  ],
  "relationship_groups": [
    {{
      "group_name": "关系群组名称",
      "group_type": "家族/朋友圈/敌对阵营/组织/联盟",
      "members": ["成员角色名"],
      "description": "群组描述",
      "internal_dynamics": "内部关系动态",
      "external_relations": "与其他群组的关系"
    }}
  ],
  "power_structure": [
    {{
      "level": 1,
      "characters": ["最高权力层角色"],
      "description": "权力结构描述"
    }}
  ],
  "conflict_networks": [
    {{
      "conflict_name": "冲突网络名称",
      "opposing_sides": [
        {{
          "side_name": "一方名称",
          "members": ["成员角色"],
          "leader": "领导者角色"
        }}
      ],
      "description": "冲突描述"
    }}
  ]
}}
```

请基于提供的角色信息分析并构建关系网络。
"""

# 知识库整合提示词
knowledge_integration_prompt = """\
作为一名专业的知识整合专家，你需要将提取的世界观、角色、剧情信息进行整合和一致性检查。

**整合目标**：
1. **一致性检查**：检查各要素间是否存在矛盾或冲突
2. **完整性评估**：评估信息的完整程度，识别缺失要素
3. **关联分析**：分析各要素间的关联关系
4. **优化建议**：提供改进和完善建议

**输入信息**：
世界观信息：
{worldview}

角色信息：
{characters}

剧情大纲：
{plot_outline}

**输出要求**：
请按照以下结构输出整合分析结果：

```json
{{
  "consistency_check": {{
    "conflicts_found": [
      {{
        "type": "矛盾类型",
        "description": "矛盾描述",
        "elements_involved": ["涉及要素"],
        "severity": "low/medium/high",
        "suggestion": "解决建议"
      }}
    ],
    "overall_consistency": "high/medium/low"
  }},
  "completeness_assessment": {{
    "worldview_completeness": "完整度百分比",
    "character_completeness": "完整度百分比", 
    "plot_completeness": "完整度百分比",
    "missing_elements": ["缺失要素列表"],
    "suggestions_for_improvement": ["改进建议"]
  }},
  "correlation_analysis": {{
    "worldview_character_links": ["世界观与角色的关联"],
    "character_plot_links": ["角色与剧情的关联"],
    "worldview_plot_links": ["世界观与剧情的关联"],
    "key_correlations": ["关键关联要素"]
  }},
  "integration_score": "整体整合度评分(1-10)",
  "recommendations": [
    {{
      "category": "建议类别",
      "priority": "high/medium/low",
      "description": "具体建议",
      "implementation": "实施方法"
    }}
  ]
}}
```

请对提供的知识要素进行全面整合分析。
"""
